/***************************Copyright (c)****************************
**                    河北稳控科技有限公司
**                    WINCOM TECH Co.,LTD.                                      
**                   http://www.winkooo.com
**
**----[文件信息]-----------------------------------------------------
** 文 件 名: main.c
** 功能描述: 主文件
**           MLX90640驱动API测试 
**
**----[创建信息]-----------------------------------------------------
** 创    建: x_lk@163.com
** 创建日期: 2019-09-15
** 版    本: 1.0
** 版本描述: 首次创建
**
**----[修改历史]-----------------------------------------------------
** 修    改: 
** 修改日期: 
** 版    本: 
** 修改内容: 
**
********************************************************************/
/*
使用说明
	本工程在Keil MDK 4.72.1.0下测试通过
	本工程可使用一组已有数据进行API测试，也可根据具体MCU进行移植后从传感器读取真实数据测试
	
	(一)使用已有数据测试
		直接运行软件仿真即可。RAM数据的测量对象是手掌，计算完成后温度范围为最低15最高30左右。
	
	(二)程序移植
	1.根据实际MCU新建工程，将本工程中的C文件添加到工程
	2.修改IIC.c，实现IIC底层支持函数
	3.修改Delay_ms();
	4.屏蔽本文件中的#ifdef SOFT_TEST行
	5.观察读取到的控制寄存器，默认值应为0x1901
*/

/********************************************************************
**                           包含头文件
********************************************************************/
#include "cpu.h"
#include "IIC.h"
#include "MLX90640.h"
#include "MLX90640_ExFun.h"

// #define SOFT_TEST

#define INTER_TIME		1	//插值次数，0:不插值;1:插值1次;2:插值2次

#ifdef SOFT_TEST	//使用实际硬件测试时，屏蔽此行


const UINT16 MLX_REG[23]={	0x0000,0x00B6,0x699F,0x0000,0x2061,0x0004,0x0320,0x03E0,
							0x1A20,0x0206,0x0187,0x0499,0x0000,0x1901,0x0000,0x0000,
							0xBE33,0x8000,0x0000,0x0000,0xFFFF,0xFFFF,0xFFFF};
const UINT16 MLX_EEM[832]={
0x00B6,0x699F,0x0000,0x2061,0x0004,0x0320,0x03E0,0x1A20,0x0206,0x0187,0x0499,0x0000,0x1901,0x0000,0x0000,0xBE33,0x4320,0xFFAC,0x0202,0x0202,0x0102,0xF1F1,0xE0E1,0xBFD0,0x0F00,0x0000,0x0001,0x0101,0xF102,0xF1F2,0xE0F2,0xC0E1,
0x8895,0x36D8,0xEECB,0x2100,0x3332,0x2233,0x0011,0xBBEE,0xCCBA,0xFFEE,0x2111,0x2222,0x2233,0x1222,0x0011,0xDDFF,0x174E,0x2FA7,0x2559,0xA182,0x4333,0x09CD,0x4843,0x4341,0x2352,0xF8CB,0x17AD,0x032F,0xF600,0x9797,0x9797,0x2AFA,
0x001E,0xFBF0,0x23C0,0xF40E,0x07EE,0x0042,0x140E,0xF02E,0x0780,0xF840,0x1850,0xEF6E,0x005E,0xF890,0x0890,0xE4AE,0x03A0,0xF3E0,0x0860,0xEC8E,0xF480,0xF860,0x03C0,0xE09E,0xF092,0xE490,0x0460,0xE00E,0xE4CE,0xE430,0x00B0,0xD89E,
0x13F2,0x07EE,0x13BE,0x1BE0,0x1BE2,0x0C30,0x040E,0x1810,0x1B82,0x042E,0x086E,0x1B30,0x1452,0x0870,0xFC7E,0x1060,0x1F84,0x07BE,0x004E,0x1C40,0x0C52,0x0C2E,0xFFBE,0x1460,0x1062,0xFC6E,0x043E,0x17D0,0x04A2,0x0010,0xFCAE,0x0C60,
0xFBCE,0xF7B0,0x1BB0,0xEFC0,0x0B8E,0xFFF2,0x1000,0xEC2E,0x034E,0xF400,0x1420,0xEB6E,0x0020,0xF480,0x0440,0xE03E,0xF7D0,0xEFB0,0x0BF0,0xE81E,0xF410,0xFBE0,0x0720,0xE02E,0xF400,0xE800,0x0BB0,0xE3DE,0xE840,0xE400,0xFCB0,0xDC2E,
0x1022,0x000E,0x082E,0x1810,0x23E2,0x0C50,0x046E,0x1872,0x1BB2,0x0860,0x089E,0x17B0,0x1882,0x04DE,0xFCAE,0x1080,0x1032,0x0410,0x006E,0x1C60,0x1052,0x1020,0x037E,0x1460,0x1454,0x0050,0x0800,0x1422,0x0852,0x0040,0xFD1E,0x1070,
0x03D0,0xF7C0,0x1BA0,0xEC1E,0x13C0,0x03E0,0x1B80,0xEC4E,0x0B80,0xFBF0,0x1410,0xEB70,0x0450,0xF830,0x0040,0xE7FE,0xFF60,0xF720,0x0BA0,0xF3FE,0xFBF2,0xF850,0x0700,0xEBE0,0xF012,0xEFA0,0x07D0,0xE3CE,0xE48E,0xEBE0,0x0412,0xE00E,
0x1042,0xF81E,0x040E,0x0C60,0x1C12,0x0C30,0x0BEE,0x1090,0x1BE2,0x0450,0x087E,0x0FA0,0x1892,0x047E,0xF48E,0x1030,0x13D4,0x0770,0x03FE,0x1820,0x1054,0x089E,0xFF5E,0x1412,0x0C54,0x03E0,0x0410,0x0C00,0x00D2,0xFC20,0x0070,0x0C40,
0x03C0,0xFF72,0x1400,0xEC3E,0x0040,0x0062,0x1080,0xE8EE,0x03E0,0xF882,0x14A0,0xE7E0,0xFC40,0xF860,0x0820,0xE450,0xFB72,0xF792,0x0430,0xE87E,0xF422,0x03B2,0x0360,0xE43E,0xF7F2,0xE820,0x0BB2,0xE7A0,0xEC20,0xEFF0,0x0452,0xE03E,
0x0B92,0xFF20,0xFFEE,0x0FF2,0x0C12,0x0030,0xF86E,0x0882,0x0FA2,0xFC40,0xFC6E,0x0B70,0x0C02,0x0020,0xF3FE,0x0802,0x0F34,0xFF40,0xF7FE,0x1030,0x0BE4,0x0B80,0xF34E,0x13D0,0x0FC4,0xFBF0,0xFF9E,0x1350,0x07E2,0xFFA0,0xF800,0x0FF0,
0xF7E0,0xF7C2,0x17F0,0xE470,0x0020,0xF8B2,0x08B0,0xE8D0,0xFBFE,0xF850,0x1040,0xE7A0,0xF450,0xF832,0x0042,0xE020,0xF3F0,0xF3C2,0x0012,0xE87E,0xEC62,0xFC10,0xF7E0,0xE7F0,0xF3C2,0xE812,0x07E0,0xE750,0xEFD2,0xE812,0xFCC2,0xE7F0,
0xFB92,0xEF60,0xF7CE,0xF832,0x07F2,0xF460,0xE87E,0x0082,0x03B2,0xF400,0xF40E,0x0350,0x0002,0xFFDE,0xE81E,0x03C0,0xFFB2,0xF770,0xEFDE,0x0800,0xFC24,0x03C0,0xE79E,0x0B82,0x0764,0xF7C0,0xF790,0x0F10,0x0784,0xF7C0,0xF070,0x0FA2,
0x1F80,0x1752,0x3330,0x043E,0x2BD0,0x1482,0x2440,0x0480,0x1BD2,0x17D2,0x2800,0x0360,0x1C10,0x1422,0x1820,0xFC20,0x1762,0x0FB2,0x1800,0x0FA0,0x0C12,0x1420,0x1770,0x03C0,0x0B92,0x0F62,0x1B90,0xFF40,0xFC30,0x07B0,0x1442,0xFFF0,
0xFBA2,0xE780,0xF36E,0xF052,0x0BF2,0xEC90,0xE48E,0xF8B2,0xF802,0xF010,0xEC3E,0xF780,0x0042,0xEC50,0xDC5E,0xF440,0xFF74,0xEFD0,0xE03E,0x0BC0,0xF432,0xF450,0xE3AE,0x03F0,0xFBC2,0xF390,0xEFCE,0x0360,0xF062,0xF3D0,0xE870,0xFC10,
0x03A0,0x0F82,0x27A0,0x03E0,0x0C00,0x1052,0x1870,0xF8E0,0x0400,0x13F2,0x2020,0xFB50,0x0470,0x0C42,0x1002,0xF430,0x0F22,0x07C2,0x17E0,0x0010,0x0020,0x1012,0x1322,0xF430,0x03C2,0x0B52,0x1F42,0xFF20,0xF820,0x03F2,0x1062,0xFBFE,
0xFFD2,0xF3A0,0xFBDE,0x0800,0x0812,0x0070,0xF09E,0x04D0,0x0432,0x0410,0xFC4E,0x1350,0x0490,0x0460,0xF03E,0x0840,0x1352,0xFFE0,0xF41E,0x1810,0x0844,0x0C40,0xF76E,0x1052,0x0C04,0x0B70,0x0B6E,0x1F40,0x0842,0x0400,0xFC80,0x1810,
0xF7DE,0x0B92,0x1BE0,0xFBF0,0x0020,0x0C52,0x0CC0,0xF4B0,0xF870,0x0852,0x10D0,0xF3B0,0xFC80,0x0492,0x0840,0xECC0,0xFF80,0xFFD0,0x0820,0xFC10,0xFC32,0x0C22,0x0790,0xF050,0xFBF2,0x03C2,0x0C10,0xF790,0xF420,0x03F0,0x0872,0xF04E,
0xEFE2,0xEF80,0xE7FE,0xFFE2,0xFC32,0xF460,0xE0DE,0x00A0,0xF092,0xF450,0xE50E,0xFFD2,0xFCA2,0xF8A0,0xE46E,0xFCC0,0xFFB2,0xF7D0,0xE45E,0x0C20,0x0052,0x0430,0xE7BE,0x0870,0x0F94,0xFFC0,0xF03E,0x13A0,0x0432,0xFC00,0xF09E,0x1030,
0xFF80,0xFFE2,0x1390,0xEC40,0xFC00,0xFC72,0x0040,0xE8E0,0xFFF0,0xFC72,0x0470,0xEBB0,0xF8B0,0xF8B2,0xF860,0xE460,0xF422,0xF422,0xF8B0,0xF060,0xF052,0x00A2,0xFF80,0xE8A0,0xEC12,0xF422,0xFFF0,0xEBD0,0xEFF0,0xF420,0xF860,0xE83E,
0x0B82,0xF7D0,0xFFAE,0x0832,0x0FF2,0x0070,0xF04E,0x08D0,0x17F2,0x0080,0xFC9E,0x0FC0,0x10D2,0x04D0,0xF0AE,0x0C70,0x1042,0x0430,0xF0DE,0x2070,0x1062,0x10B0,0xFB9E,0x1890,0x1422,0x0840,0x041E,0x1FD0,0x1802,0x1020,0x047E,0x2020,
0xF7AE,0x0F52,0x1BA0,0xFC00,0x07BE,0x0C72,0x17E0,0x0020,0x03AE,0x0C60,0x1860,0xFBC0,0x0460,0x0CD2,0x0C50,0xF820,0x0790,0x0812,0x0C40,0x006E,0xFC70,0x1452,0x0BA0,0xFC50,0xF880,0x13A2,0x1400,0x077E,0xF830,0x0FD0,0x0C50,0x07C0,
0xDF80,0xE350,0xDF9E,0xF7E0,0xF3A0,0xE860,0xDFEE,0xFC20,0xF390,0xEC40,0xE85E,0xFFC0,0xF860,0xF0EE,0xDC5E,0x0030,0xFFA2,0xF010,0xE05E,0x0C50,0xF882,0x044E,0xE3DE,0x0C60,0xF892,0x03C0,0xF00E,0x1760,0x0012,0x03C0,0xF04E,0x1B90,
0xE370,0xFF82,0x03C0,0xEFD0,0xEBCE,0x0012,0xFFE0,0xE880,0xEF8E,0xFC10,0x04A0,0xE7DE,0xF0AE,0xFCF0,0xF8B0,0xEC5E,0xEC30,0xF852,0xF8C0,0xF48E,0xECB0,0x04D0,0xFF80,0xF0A0,0xF030,0x0020,0x07F0,0xF76E,0xF3A0,0x03D0,0x03D0,0xF7DE,
0xEB42,0xEB50,0xDFAE,0x03A0,0xF3B0,0xF7F0,0xE3DE,0xFC70,0xFF50,0xFBEE,0xEC7E,0x07A0,0x0080,0xFCE0,0xE0BE,0x0C30,0xFC30,0xFC6E,0xE4CE,0x1490,0x00A2,0x0CD0,0xF39E,0x1480,0x0C32,0x041E,0xFFDE,0x2730,0x1782,0x0FB0,0x03BE,0x2780,
0xE83E,0x0FA2,0x1390,0xFC00,0x07CE,0x1432,0x0800,0xFC3E,0xF41E,0x13E2,0x089E,0xFF7E,0x049E,0x10A0,0x00CE,0xF4FE,0xFC80,0x08A0,0x0CDE,0x04FE,0xF930,0x1D00,0x0420,0x00EE,0xF4AE,0x1040,0x042E,0x07AE,0xF7FE,0x1F70,0x004E,0x179E,
0xE010,0xF37E,0xE78E,0x07D0,0x0390,0x03FE,0xE7EE,0x0800,0xFBD0,0x07CE,0xEC8C,0x0B5E,0x0C70,0x048E,0xE8AC,0x08CE,0x0460,0x049E,0xF0BC,0x20D0,0x0920,0x14FE,0xF02C,0x20B0,0x1070,0x101E,0xFC1C,0x2780,0x1BD0,0x274E,0x003E,0x377E
};
const UINT16 MLX_RAM[832]={
0xFFA1,0xFF9C,0xFFA5,0xFF9B,0xFF9F,0xFF9B,0xFFA4,0xFF99,0xFFA3,0xFF9B,0xFFAC,0xFFB3,0xFFD9,0xFFD2,0xFFDD,0xFFCE,0xFFDC,0xFFCE,0xFFD5,0xFFBB,0xFFBD,0xFFB0,0xFFBB,0xFFAA,0xFFB6,0xFFA6,0xFFB6,0xFFA3,0xFFAF,0xFFA0,0xFFB0,0xFF94,
0xFF94,0xFF94,0xFF91,0xFF94,0xFF92,0xFF91,0xFF90,0xFF92,0xFF98,0xFF92,0xFFA0,0xFFA5,0xFFCD,0xFFC9,0xFFCC,0xFFC9,0xFFD3,0xFFC9,0xFFC6,0xFFBB,0xFFB5,0xFFA9,0xFFAB,0xFFA5,0xFFAE,0xFFA2,0xFFA6,0xFFA0,0xFFA4,0xFF9C,0xFF9F,0xFF90,
0xFF9F,0xFF9A,0xFFA2,0xFF9A,0xFFA0,0xFF9B,0xFFA4,0xFF9C,0xFFA9,0xFFA7,0xFFC8,0xFFCB,0xFFD8,0xFFD0,0xFFDE,0xFFD1,0xFFE0,0xFFD4,0xFFDD,0xFFCD,0xFFC5,0xFFB4,0xFFBF,0xFFB0,0xFFC5,0xFFAF,0xFFBC,0xFFA2,0xFFAA,0xFF97,0xFFA8,0xFF8F,
0xFF92,0xFF90,0xFF8F,0xFF93,0xFF96,0xFF93,0xFF95,0xFF97,0xFFA6,0xFFA6,0xFFC6,0xFFC6,0xFFCC,0xFFC8,0xFFCD,0xFFCC,0xFFD6,0xFFCE,0xFFD0,0xFFCA,0xFFC1,0xFFB0,0xFFB0,0xFFAC,0xFFBB,0xFFAD,0xFFA1,0xFF96,0xFF95,0xFF8B,0xFF92,0xFF88,
0xFFA1,0xFF9B,0xFFA3,0xFF9B,0xFFA7,0xFFA5,0xFFB6,0xFFB6,0xFFD2,0xFFCF,0xFFDA,0xFFD0,0xFFDC,0xFFD3,0xFFDF,0xFFD3,0xFFE3,0xFFD7,0xFFE2,0xFFD3,0xFFDE,0xFFC5,0xFFCB,0xFFBC,0xFFBF,0xFF9D,0xFF9F,0xFF8A,0xFF9A,0xFF8E,0xFFA5,0xFF8D,
0xFF93,0xFF90,0xFF90,0xFF94,0xFFA1,0xFFA0,0xFFBD,0xFFBD,0xFFCB,0xFFC6,0xFFC8,0xFFC8,0xFFD0,0xFFCA,0xFFCE,0xFFCC,0xFFD6,0xFFCE,0xFFCE,0xFFCB,0xFFD3,0xFFC7,0xFFBB,0xFFB7,0xFFA2,0xFF8F,0xFF8A,0xFF84,0xFF8D,0xFF86,0xFF95,0xFF87,
0xFFA2,0xFFA1,0xFFAB,0xFFA9,0xFFC0,0xFFCA,0xFFD4,0xFFC8,0xFFCB,0xFFBD,0xFFD7,0xFFD1,0xFFDA,0xFFD4,0xFFE2,0xFFD5,0xFFE0,0xFFD3,0xFFDF,0xFFD1,0xFFDE,0xFFD0,0xFFC5,0xFF9F,0xFF9F,0xFF8D,0xFF9D,0xFF89,0xFF99,0xFF8D,0xFFA6,0xFF8E,
0xFF97,0xFF96,0xFFA2,0xFFAA,0xFFBE,0xFFBF,0xFFB9,0xFFB9,0xFFA2,0xFF9E,0xFFC6,0xFFC7,0xFFCE,0xFFC9,0xFFCC,0xFFCA,0xFFD1,0xFFC8,0xFFCA,0xFFC9,0xFFCE,0xFFC1,0xFF98,0xFF8F,0xFF92,0xFF84,0xFF89,0xFF83,0xFF8D,0xFF84,0xFF94,0xFF87,
0xFFA4,0xFFAD,0xFFC9,0xFFC1,0xFFC2,0xFFAE,0xFFAC,0xFFA8,0xFFC6,0xFFD0,0xFFDD,0xFFD0,0xFFDA,0xFFD6,0xFFE1,0xFFD3,0xFFDD,0xFFCF,0xFFDC,0xFFCD,0xFFC9,0xFFA7,0xFF9C,0xFF8D,0xFF9D,0xFF8C,0xFF9B,0xFF8A,0xFF99,0xFF8A,0xFFA3,0xFF8E,
0xFF97,0xFF98,0xFFAE,0xFFB0,0xFF98,0xFF93,0xFF9F,0xFFA8,0xFFC8,0xFFC4,0xFFC0,0xFFBB,0xFFC4,0xFFC7,0xFFCA,0xFFC8,0xFFCD,0xFFC6,0xFFC5,0xFFC0,0xFFA3,0xFF90,0xFF87,0xFF86,0xFF91,0xFF82,0xFF87,0xFF82,0xFF8D,0xFF81,0xFF8E,0xFF85,
0xFFA2,0xFF9D,0xFFA5,0xFF9A,0xFFA6,0xFFAA,0xFFCE,0xFFCE,0xFFD5,0xFFC4,0xFFB0,0xFFA0,0xFFC9,0xFFD4,0xFFD4,0xFFC2,0xFFDD,0xFFD0,0xFFCE,0xFFAC,0xFF9D,0xFF8F,0xFF9B,0xFF8C,0xFF9A,0xFF8D,0xFF98,0xFF89,0xFF94,0xFF8B,0xFF9E,0xFF8B,
0xFF8E,0xFF8A,0xFF8C,0xFF8D,0xFFA4,0xFFA5,0xFFBF,0xFFC1,0xFFB0,0xFFA5,0xFF91,0xFF92,0xFFCB,0xFFC6,0xFFA6,0xFFA2,0xFFCD,0xFFC3,0xFFA3,0xFF94,0xFF8D,0xFF84,0xFF85,0xFF83,0xFF8E,0xFF81,0xFF85,0xFF7F,0xFF87,0xFF80,0xFF8C,0xFF80,
0xFF99,0xFF99,0xFFA4,0xFFAB,0xFFC8,0xFFCB,0xFFC8,0xFFA6,0xFF9C,0xFF98,0xFFAA,0xFFC7,0xFFD6,0xFFC3,0xFFB1,0xFFB6,0xFFD9,0xFFC2,0xFFA6,0xFF8F,0xFF99,0xFF8F,0xFF99,0xFF8A,0xFF99,0xFF8D,0xFF99,0xFF89,0xFF94,0xFF89,0xFF9C,0xFF88,
0xFF87,0xFF86,0xFF93,0xFF9B,0xFFB8,0xFFB7,0xFF8D,0xFF8C,0xFF89,0xFF88,0xFFB2,0xFFB6,0xFFBA,0xFFB3,0xFF9B,0xFFAA,0xFFC7,0xFFB5,0xFF87,0xFF84,0xFF89,0xFF81,0xFF83,0xFF80,0xFF8B,0xFF82,0xFF86,0xFF80,0xFF87,0xFF7D,0xFF88,0xFF7D,
0xFF97,0xFF9A,0xFF9F,0xFFA6,0xFFAC,0xFF9C,0xFF9A,0xFF93,0xFF99,0xFFAA,0xFFCE,0xFFC8,0xFFB5,0xFF98,0xFFB5,0xFFC8,0xFFCD,0xFFA6,0xFF9E,0xFF8E,0xFF99,0xFF8F,0xFF98,0xFF8B,0xFF9B,0xFF90,0xFF99,0xFF8A,0xFF97,0xFF8B,0xFF9A,0xFF87,
0xFF83,0xFF85,0xFF82,0xFF88,0xFF86,0xFF86,0xFF7F,0xFF83,0xFF95,0xFF93,0xFFB8,0xFFBA,0xFF8B,0xFF88,0xFFB0,0xFFB9,0xFFA7,0xFF92,0xFF86,0xFF82,0xFF89,0xFF81,0xFF81,0xFF80,0xFF90,0xFF83,0xFF83,0xFF80,0xFF88,0xFF7E,0xFF85,0xFF7C,
0xFF9A,0xFF95,0xFF9A,0xFF93,0xFF98,0xFF94,0xFF99,0xFF94,0xFFAA,0xFFC7,0xFFC6,0xFF98,0xFF99,0xFF9D,0xFFCD,0xFFC6,0xFFA8,0xFF91,0xFF99,0xFF8E,0xFF98,0xFF8D,0xFF98,0xFF89,0xFF98,0xFF8C,0xFF94,0xFF87,0xFF93,0xFF87,0xFF97,0xFF84,
0xFF84,0xFF80,0xFF7E,0xFF81,0xFF81,0xFF80,0xFF7E,0xFF80,0xFFA7,0xFFA0,0xFF88,0xFF89,0xFF89,0xFF8C,0xFFB8,0xFFB1,0xFF8A,0xFF80,0xFF7F,0xFF80,0xFF88,0xFF7F,0xFF81,0xFF7D,0xFF8B,0xFF7F,0xFF7F,0xFF7A,0xFF84,0xFF79,0xFF82,0xFF78,
0xFF90,0xFF94,0xFF95,0xFF90,0xFF92,0xFF90,0xFF96,0xFF91,0xFF96,0xFF92,0xFF98,0xFF8C,0xFF97,0xFFA1,0xFFB3,0xFF9C,0xFF99,0xFF8F,0xFF98,0xFF8C,0xFF97,0xFF90,0xFF9C,0xFF94,0xFFA0,0xFF97,0xFF9B,0xFF89,0xFF90,0xFF87,0xFF92,0xFF84,
0xFF7A,0xFF7E,0xFF77,0xFF7C,0xFF7D,0xFF7C,0xFF78,0xFF7D,0xFF7F,0xFF7C,0xFF7B,0xFF7D,0xFF84,0xFF81,0xFF86,0xFF84,0xFF85,0xFF7D,0xFF7D,0xFF7D,0xFF85,0xFF81,0xFF83,0xFF86,0xFF90,0xFF8A,0xFF84,0xFF7F,0xFF80,0xFF78,0xFF7D,0xFF76,
0xFF8E,0xFF90,0xFF8F,0xFF8D,0xFF8C,0xFF8F,0xFF91,0xFF8A,0xFF8F,0xFF8D,0xFF92,0xFF8A,0xFF92,0xFF90,0xFF97,0xFF8E,0xFF95,0xFF8C,0xFF96,0xFF8C,0xFF98,0xFF93,0xFF9A,0xFF8F,0xFF9E,0xFF94,0xFF9B,0xFF8B,0xFF91,0xFF85,0xFF91,0xFF81,
0xFF75,0xFF77,0xFF70,0xFF79,0xFF76,0xFF78,0xFF73,0xFF75,0xFF7A,0xFF77,0xFF74,0xFF78,0xFF7E,0xFF7B,0xFF7A,0xFF7D,0xFF81,0xFF7A,0xFF7B,0xFF7C,0xFF86,0xFF7F,0xFF80,0xFF7F,0xFF8C,0xFF83,0xFF84,0xFF80,0xFF80,0xFF74,0xFF7A,0xFF72,
0xFF89,0xFF8E,0xFF8E,0xFF8C,0xFF8C,0xFF8D,0xFF8D,0xFF89,0xFF8B,0xFF8B,0xFF8D,0xFF89,0xFF90,0xFF8D,0xFF91,0xFF8A,0xFF9A,0xFF96,0xFF9B,0xFF8B,0xFF96,0xFF92,0xFF9A,0xFF92,0xFF9E,0xFF99,0xFF9C,0xFF91,0xFF8E,0xFF88,0xFF89,0xFF80,
0xFF65,0xFF6B,0xFF65,0xFF6B,0xFF6B,0xFF6C,0xFF64,0xFF6B,0xFF6C,0xFF6B,0xFF65,0xFF6A,0xFF6F,0xFF6D,0xFF6C,0xFF71,0xFF81,0xFF7C,0xFF72,0xFF70,0xFF79,0xFF74,0xFF77,0xFF78,0xFF85,0xFF7E,0xFF7D,0xFF7A,0xFF75,0xFF6C,0xFF69,0xFF65,
0x4D71,0x18AE,0x7FFF,0x18AE,0x7FFF,0x18AD,0x7FFF,0x18AD,0xFFA9,0xCF85,0x17A8,0xD816,0x0000,0x000C,0x0003,0xFFFE,0x195E,0x03FF,0x0269,0x7FFF,0x195D,0x03FF,0x0269,0x7FFF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x062B,0x7FFF,0x18AE,0x7FFF,0x18AE,0x7FFF,0x18AD,0x7FFF,0xFFAA,0xF521,0xD0F4,0xD738,0x000D,0x0005,0xFFFE,0xFFFF,0x00F5,0x004D,0x275D,0x0048,0x00F5,0x004D,0x275D,0x0048,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000
};
#endif

void GetEEPROM(UINT16 *eeprom)
{	
#ifdef SOFT_TEST
	UINT16 i;
	
	for (i=0;i<832;i++)
		eeprom[i]=MLX_EEM[i];
#else
	MLX90640_I2CRead(0x2400, 832, eeprom);//从MLX90640传感器中读取真实数据
#endif
}
void GetRAM(UINT16 *ram)
{
#ifdef SOFT_TEST
	UINT16 i;

	for (i=0;i<832;i++)
		ram[i]=MLX_RAM[i];
#else
	MLX90640_I2CRead(0x0400, 832, ram);//从MLX90640传感器中读取真实数据
#endif
}
UINT16 GetStatusReg(void)
{
	UINT16 staReg;
#ifdef SOFT_TEST	
	staReg=0x0000;
#else
	MLX90640_I2CRead(0x8000, 1, &staReg);//从MLX90640传感器中读取真实数据
#endif
	return staReg;
}
UINT16 GetControlReg(void)
{
	UINT16 ctrReg;
#ifdef SOFT_TEST
	ctrReg=0x1901;
#else
	MLX90640_I2CRead(0x800D, 1, &ctrReg);//从MLX90640传感器中读取真实数据
#endif
	return ctrReg;
}

void SystemInit(void)
{
	//MCU初始化
}
int main(void)
{
#ifdef SOFT_TEST
	UINT16 whileCount=0;
#endif
	UINT32 i,colIndex,rowIndex;
	UINT32 colCount,rowCount,pixCount;
	UINT16 Datas_n16[834];//读取EEPROM或者RAM的临时数组
	UINT16 statusRegister,controlRegister1;//状态和控制寄存器实时值
	paramsMLX90640 mlx90640Pars;//解释后的温度计算校正参数	
	float emissivity = 0.95;//被测对象（物体）的热辐射系数，人体为0.95，其它物体请百度
	float Vdd,Ta,tr;//MLX90640的电压、外壳温度、环境校正温度实时测量值
	float mlx90640To[768];//768像素温度值，单位：摄氏度
	UINT8 Frame0Ok=0,Frame1Ok=0;
	UINT8 Color[4];//4个字节分别为：灰度值、R、G、B(三原色)
	
#if INTER_TIME>0
	float mlxTemp_Interpolation1[12288];//第1次插值后的温度		128*96 =12288
#elif INTER_TIME>1
	float mlxTemp_Interpolation2[196608];//第2次插值后的温度	512*384=196608
#endif

	
	SystemInit();				//MCU初始化
	IIC_Init();					//IIC接口初始化
	Delay_ms(20);
	MLX90640_I2CInit();			//MLX90640初始化
	Delay_ms(50);
	
	//设置MLX90640参数
	MLX90640_SetResolution(2);	//测量分辨率18位(0~3对应16,17,18,19位分辨率)
	MLX90640_SetRefreshRate(0);	//测量速率1Hz(0~7对应0.5,1,2,4,8,16,32,64Hz)
	MLX90640_SetArrangeMode(1);	//帧模式，棋盘模式（像素交错模式）,0:TV行交错;1:棋盘像素交错;
	
	Delay_ms(200);
	
	//读取MLX90640校准参数(MLX90640内部存储器的地址0x2400~0x273F)
	GetEEPROM(Datas_n16);
	
	MLX90640_ExtractParameters(Datas_n16, &mlx90640Pars);
	
	Delay_ms(50);
	while (1)
	{
		Delay_ms(20);
		
		statusRegister=GetStatusReg();
		controlRegister1=GetControlReg();
#ifdef SOFT_TEST
		statusRegister=0x0008|(whileCount&0x0001);
		whileCount++;
#endif
		
		if (statusRegister&0x0008)//有测量完成的Frame
		{
			MLX90640_I2CWrite(0x8000, statusRegister&(~0x0018));//往状态寄存器bit3写0，复位测量完成标志
			
			//读取RAM，并和另外两个寄存器值打包成计算需要的原始数据
			GetRAM(Datas_n16);
			Datas_n16[832]=controlRegister1;
			Datas_n16[833]=statusRegister&0x0001;
			
			if (Datas_n16[833]==0) Frame0Ok=1;
			if (Datas_n16[833]==1) Frame1Ok=1;
			
			Vdd=MLX90640_GetVdd(Datas_n16, &mlx90640Pars);
			Vdd=Vdd;//Vdd应等于3.3V左右。此句无意义，仅是为了不让编译器优化掉Vdd
			
			//计算本帧温度值到mlx90640To数组
			Ta= MLX90640_GetTa(Datas_n16, &mlx90640Pars);
			tr = Ta-8.0;
			MLX90640_CalculateTo(Datas_n16, &mlx90640Pars, emissivity, tr, mlx90640To);
			
			//不良像素处理
			if ((Frame0Ok) && (Frame1Ok))
			{
				MLX90640_BadPixelsCorrection(mlx90640Pars.brokenPixels, mlx90640To, 1, &mlx90640Pars);
				MLX90640_BadPixelsCorrection(mlx90640Pars.outlierPixels, mlx90640To, 1, &mlx90640Pars);
			}
			colCount=32;rowCount=24;pixCount=768;//32*24=768
#if INTER_TIME>0			
			//第1次多项式插值（像素行和列各扩大4倍，即:由32*24=768扩展为128*96=12288）
			if ((Frame0Ok) && (Frame1Ok))
			{
				PolynomialInterpolation_Matrix(mlx90640To,colCount,rowCount,0,2,mlxTemp_Interpolation1);
				colCount=128;rowCount=96;pixCount=12288;//128*96=12288
			}
#elif INTER_TIME>1
			//第2次多项式插值（像素行和列各扩大4倍，即:由128*96=12288扩展为512*384=196608）
			if ((Frame0Ok) && (Frame1Ok))
			{
				PolynomialInterpolation_Matrix(mlxTemp_Interpolation1,colCount,rowCount,1,2,mlxTemp_Interpolation2);
				colCount=512;rowCount=384;pixCount=196608;//512*384=196608
			}
#endif
			
			//温度-颜色变换
			if ((Frame0Ok) && (Frame1Ok))
			{
				for (i=0;i<pixCount;i++)
				{
					TemperatureToRGB(mlxTemp_Interpolation1[i],0.0,35.0,Color);
					//计算此像素的行和列值
					rowIndex=i/colCount;
					colIndex=i%colCount;
					rowIndex=rowIndex;colIndex=colIndex;//此行无意义，仅是为了不让编译器优化掉rowIndex和colIndex
					/*
					颜色值进一步使用，如:打印到屏幕上
					Color[0]:颜色灰度值
					Color[1]:由灰度转换为彩色，R值
					Color[2]:由灰度转换为彩色，G值
					Color[3]:由灰度转换为彩色，B值
					*/
				}				
			}
		}		
	}
}

/********************************************************************
**                            End Of File
********************************************************************/

