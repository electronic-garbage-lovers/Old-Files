
	INCLUDE equates.h
	INCLUDE 6502mac.h

	IMPORT NES_RAM		 ;nes_main.c 
;	IMPORT prg_rombank0	 ;nes_main.c 
;	IMPORT prg_rombank1	 ;nes_main.c 
	IMPORT spr_ram		 ;ppu.c

	EXPORT op_table	   ;代码跳转表地址 cart.s
	EXPORT line242NMI
	EXPORT CPU_reset
	EXPORT run

IRQ_VECTOR		EQU 0xfffe ; //IRQ / BRK中断向量地址
RES_VECTOR		EQU 0xfffc ;// 复位中断向量地址
NMI_VECTOR		EQU 0xfffa ;// NMI中断向量地址

;cycle flags- (stored in cycles reg for speed)存储在周期章速度

CYC_C			EQU 0x01	;Carry bit 进位
;BRANCH			EQU 0x02	;branch instruction encountered	遇到分支指令
CYC_I			EQU 0x04	;IRQ mask
CYC_D			EQU 0x08	;Decimal bit	小数位
CYC_V			EQU 0x40	;Overflow bit	 溢出位
;CYC_MASK		EQU 0xFF;CYCLE-1	;Mask


	;   AREA wram_code0, CODE, READWRITE
   AREA cpu_code, CODE, READONLY ;, ALIGN=2
											;	不要对 ARM 代码节使用 ALIGN=0 或 ALIGN=1。
                                           ;    不要对 Thumb 代码节使用 ALIGN=0。
   ;AREA  伪代码也是需要语法的，AREA  后面跟着段名标号，然后是属性，CODE 表示这是一 
	;个代码段，READONLY 表示这个段是只读的
	;|.text|系统默认的代码段名  
	; ALIGN 指令通过用零或 NOP 指令进行填充将当前位置对齐到指定边界
	;ENTRY  这个伪代码是用来定义入口点
	THUMB	 ;Thumb是ARM体系结构中一种16位的指令集
;	REQUIRE8  ;REQUIRE8 指令指定当前文件要求堆栈八字节对齐。 它设置 REQ8 编译属性以通知链接器。
	PRESERVE8 ;{TRUE} ;PRESERVE8 指令指定当前文件保持堆栈八字节对齐。 它设置 PRES8 编译属性以通知链接器。
			  ;如果您省略 PRESERVE8 和 PRESERVE8 {FALSE}，汇编程序会检查修改 sp 的指令，
			  ;以决定是否设置 PRES8 编译属性。 ARM 建议明确指定 PRESERVE8。
			  ; ARM使用r0作为返回值
			  ;参数传递ARM：寄存器到堆栈，首先将参数赋给r0, r1等

 ;  PROC 为子程序开始，ENDP 为子程序结束


		;r0,r1,r2=temp regs	  
m6502_nz	RN r3 ;bit 31=N, Z=1 if bits 0-7=0		  ;RN定义寄存器名
m6502_rmem	RN r4 ;readmem_tbl
m6502_a		RN r5 ;//bits 0-23=0, 还用于清除在内存中的字节
m6502_x		RN r6 ;bits 0-23=0
m6502_y		RN r7 ;bits 0-23=0
cycles		RN r8 ;//also VDIC flags也VDIC标志
m6502_pc	RN r9
globalptr	RN r10 ;=wram_globals* ptr
m6502_optbl	RN r10
cpu_zpage	RN r11 ;=CPU_RAM
addy		RN r12 ;//keep this at r12 (从头 APCS)	//addr  :代表8位地址 
		;r13=SP
		;r14=LR
		;r15=PC
;---------------------------------------------------
	

_00;   BRK
;----------------------------------------------------------------------------

	ldr r0,lastbank		 ;	  6502PC从 ROM的最后偏移量
	sub r1,m6502_pc,r0
	add r0,r1,#1
	push16			;save PC

	encodeP (B+R)		;save P

	ldr r12,=IRQ_VECTOR
	bl VecCont

	fetch 7
	LTORG			 ;指令， LTORG可能是在一个可执行的位置
;----------------------------------------------------------------------------
_01;   ORA ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opORA
	fetch 6
;----------------------------------------------------------------------------
_05;   ORA $nn
;----------------------------------------------------------------------------
	doZ
	opORA
	fetch 3
;----------------------------------------------------------------------------
_06;   ASL $nn
;----------------------------------------------------------------------------
	doZ
	opASL
	fetch_c 5
;----------------------------------------------------------------------------
_08;   PHP
;----------------------------------------------------------------------------
	encodeP (B+R)
	push8 r0
	fetch 3
;----------------------------------------------------------------------------
_09;   ORA #$nn
;----------------------------------------------------------------------------
	doIMM
	opORA
	fetch 2
;----------------------------------------------------------------------------
_0A;   ASL
;----------------------------------------------------------------------------
	adds m6502_a,m6502_a,m6502_a
	mov m6502_nz,m6502_a,asr#24		;NZ
	orr cycles,cycles,#CYC_C		;Prepare C
	fetch_c 2						;also subs carry
;----------------------------------------------------------------------------
_0D;   ORA $nnnn
;----------------------------------------------------------------------------
	doABS
	opORA
	fetch 4
;----------------------------------------------------------------------------
_0E;   ASL $nnnn
;----------------------------------------------------------------------------
	doABS
	opASL
	fetch_c 6
;----------------------------------------------------------------------------	 
_10;   BPL *
;----------------------------------------------------------------------------
	tst m6502_nz,#0x80000000
	ldrsb r0,[m6502_pc],#1
	addeq m6502_pc,m6502_pc,r0
;	subeq cycles,cycles,#3*CYCLE
	subeq cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_11;   ORA ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opORA
	fetch 5
;----------------------------------------------------------------------------
_15;   ORA $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opORA
	fetch 4
;----------------------------------------------------------------------------
_16;   ASL $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opASL
	fetch_c 6
;----------------------------------------------------------------------------
_18;   CLC
;----------------------------------------------------------------------------
	bic cycles,cycles,#CYC_C
	fetch 2
;----------------------------------------------------------------------------
_19;   ORA $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opORA
	fetch 4
;----------------------------------------------------------------------------
_1D;   ORA $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opORA
	fetch 4
;----------------------------------------------------------------------------
_1E;   ASL $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opASL
	fetch_c 7
;----------------------------------------------------------------------------
_20;   JSR $nnnn
;----------------------------------------------------------------------------
	ldrb r2,[m6502_pc],#1
	ldr r1,lastbank
	sub r0,m6502_pc,r1
	ldrb r1,[m6502_pc]
	orr m6502_pc,r2,r1,lsl#8
	push16
	encodePC
	fetch 6
;----------------------------------------------------------------------------
_21;   AND ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opAND
	fetch 6
;----------------------------------------------------------------------------
_24;   BIT $nn
;----------------------------------------------------------------------------
	doZ
	opBIT
	fetch 3
;----------------------------------------------------------------------------
_25;   AND $nn
;----------------------------------------------------------------------------
	doZ
	opAND
	fetch 3
;----------------------------------------------------------------------------
_26;   ROL $nn
;----------------------------------------------------------------------------
	doZ
	opROL
	fetch 5
;----------------------------------------------------------------------------
_28;   PLP
;----------------------------------------------------------------------------
	pop8 r0
	decodeP
	fetch 4
;----------------------------------------------------------------------------
_29;   AND #$nn
;----------------------------------------------------------------------------
	doIMM
	opAND
	fetch 2
;----------------------------------------------------------------------------
_2A;   ROL
;----------------------------------------------------------------------------
	movs cycles,cycles,lsr#1		;get C
	orrcs m6502_a,m6502_a,#0x00800000
	adds m6502_a,m6502_a,m6502_a
	mov m6502_nz,m6502_a,asr#24		;NZ
	adc cycles,cycles,cycles		;Set C
	fetch 2
;----------------------------------------------------------------------------
_2C;   BIT $nnnn
;----------------------------------------------------------------------------
	doABS
	opBIT
	fetch 4
;----------------------------------------------------------------------------
_2D;   AND $nnnn
;----------------------------------------------------------------------------
	doABS
	opAND
	fetch 4
;----------------------------------------------------------------------------
_2E;   ROL $nnnn
;----------------------------------------------------------------------------
	doABS
	opROL
	fetch 6
;----------------------------------------------------------------------------
_30;   BMI *
;----------------------------------------------------------------------------
	tst m6502_nz,#0x80000000
	ldrsb r0,[m6502_pc],#1
	addne m6502_pc,m6502_pc,r0
;	subne cycles,cycles,#3*CYCLE
	subne cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_31;   AND ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opAND
	fetch 5
;----------------------------------------------------------------------------
_35;   AND $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opAND
	fetch 4
;----------------------------------------------------------------------------
_36;   ROL $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opROL
	fetch 6
;----------------------------------------------------------------------------
_38;   SEC
;----------------------------------------------------------------------------
	orr cycles,cycles,#CYC_C
	fetch 2
;----------------------------------------------------------------------------
_39;   AND $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opAND
	fetch 4
;----------------------------------------------------------------------------
_3D;   AND $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opAND
	fetch 4
;----------------------------------------------------------------------------
_3E;   ROL $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opROL
	fetch 7
;----------------------------------------------------------------------------
_40;   RTI
;----------------------------------------------------------------------------
	pop8 r0		;pop 6502 flags and decode
	decodeP
	pop16		;pop the return address
	encodePC
	fetch 6
;----------------------------------------------------------------------------
_41;   EOR ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opEOR
	fetch 6
;----------------------------------------------------------------------------
_45;   EOR $nn
;----------------------------------------------------------------------------
	doZ
	opEOR
	fetch 3
;----------------------------------------------------------------------------
_46;   LSR $nn
;----------------------------------------------------------------------------
	doZ
	opLSR
	fetch_c 5
;----------------------------------------------------------------------------
_48;   PHA
;----------------------------------------------------------------------------
	mov r0,m6502_a,lsr#24
	push8 r0
	fetch 3
;----------------------------------------------------------------------------
_49;   EOR #$nn
;----------------------------------------------------------------------------
	doIMM
	opEOR
	fetch 2
;----------------------------------------------------------------------------
_4A;   LSR
;----------------------------------------------------------------------------
	movs m6502_nz,m6502_a,lsr#25	;Z, N=0
	mov m6502_a,m6502_nz,lsl#24		;result without garbage
	orr cycles,cycles,#CYC_C		;Prepare C
	fetch_c 2
;----------------------------------------------------------------------------
_4C;   JMP $nnnn
;----------------------------------------------------------------------------
	ldrb r0,[m6502_pc],#1
	ldrb r1,[m6502_pc]
	orr m6502_pc,r0,r1,lsl#8
	encodePC
	fetch 3
;----------------------------------------------------------------------------
_4D;   EOR $nnnn
;----------------------------------------------------------------------------
	doABS
	opEOR
	fetch 4
;----------------------------------------------------------------------------
_4E;   LSR $nnnn
;----------------------------------------------------------------------------
	doABS
	opLSR
	fetch_c 6
;----------------------------------------------------------------------------
_50;   BVC *
;----------------------------------------------------------------------------
	tst cycles,#CYC_V
	ldrsb r0,[m6502_pc],#1
	addeq m6502_pc,m6502_pc,r0
;	subeq cycles,cycles,#3*CYCLE
	subeq cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_51;   EOR ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opEOR
	fetch 5
;----------------------------------------------------------------------------
_55;   EOR $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opEOR
	fetch 4
;----------------------------------------------------------------------------
_56;   LSR $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opLSR
	fetch_c 6
;----------------------------------------------------------------------------
_58;   CLI
;----------------------------------------------------------------------------
	bic cycles,cycles,#CYC_I
	fetch 2
;----------------------------------------------------------------------------
_59;   EOR $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opEOR
	fetch 4
;----------------------------------------------------------------------------
_5D;   EOR $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opEOR
	fetch 4
;----------------------------------------------------------------------------
_5E;   LSR $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opLSR
	fetch_c 7
;----------------------------------------------------------------------------
_60;   RTS
;----------------------------------------------------------------------------
	pop16
	add m6502_pc,m6502_pc,#1
	encodePC
	fetch 6
;----------------------------------------------------------------------------
_61;   ADC ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opADC
	fetch_c 6
;----------------------------------------------------------------------------
_65;   ADC $nn
;----------------------------------------------------------------------------
	doZ
	opADC
	fetch_c 3
;----------------------------------------------------------------------------
_66;   ROR $nn
;----------------------------------------------------------------------------
	doZ
	opROR
	fetch 5
;----------------------------------------------------------------------------
_68;   PLA
;----------------------------------------------------------------------------
	pop8 m6502_nz
	mov m6502_a,m6502_nz,lsl#24
	fetch 4
;----------------------------------------------------------------------------
_69;   ADC #$nn
;----------------------------------------------------------------------------
	doIMM
	opADC
	fetch_c 2
;----------------------------------------------------------------------------
_6A;   ROR
;----------------------------------------------------------------------------
	movs cycles,cycles,lsr#1		;get C
	mov m6502_a,m6502_a,rrx
	movs m6502_nz,m6502_a,asr#24	;NZ
	and m6502_a,m6502_a,#0xff000000
	adc cycles,cycles,cycles		;Set C
	fetch 2
;----------------------------------------------------------------------------
_6C;   JMP ($nnnn)	JMP ($data16) 间接寻址 *********************************
;----------------------------------------------------------------------------		
	doABS       
	adr r1,memmap_tbl			   
	and r2,addy,#0xE000	;v9版	乘法	  
;	ldr r1,[r1,r2,lsr#11]  		  ;>>11 addr&0x7FF
	lsr r0,r2,#11			;v9版   
	ldr r1,[r1,r0]		;v9版   ;在数据传送之前,将偏移量加到Rn 中,其结果作为传送数据的存储地址
							   
	ldrb m6502_pc,[r1,addy]     ;//若使用后缀"!",则结果写回到Rn中
	add r1,r1,addy	    ;v9版

	ldrb r0,[r1,#1]	    ;v9版
	orr m6502_pc,m6502_pc,r0,lsl#8	 ;m6502_pc=r9使用ORR 指令将近R9的高8 位数据移入到R0低8位
	encodePC	
	fetch 5
;----------------------------------------------------------------------------
_6D;   ADC $nnnn
;----------------------------------------------------------------------------
	doABS
	opADC
	fetch_c 4
;----------------------------------------------------------------------------
_6E;   ROR $nnnn
;----------------------------------------------------------------------------
	doABS
	opROR
	fetch 6
;----------------------------------------------------------------------------
_70;   BVS *
;----------------------------------------------------------------------------
	tst cycles,#CYC_V
	ldrsb r0,[m6502_pc],#1
	addne m6502_pc,m6502_pc,r0
;	subne cycles,cycles,#3*CYCLE
	subne cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_71;   ADC ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opADC
	fetch_c 5
;----------------------------------------------------------------------------
_75;   ADC $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opADC
	fetch_c 4
;----------------------------------------------------------------------------
_76;   ROR $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opROR
	fetch 6
;----------------------------------------------------------------------------
_78;   SEI
;----------------------------------------------------------------------------
	orr cycles,cycles,#CYC_I
	fetch 2
;----------------------------------------------------------------------------
_79;   ADC $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opADC
	fetch_c 4
;----------------------------------------------------------------------------
_7D;   ADC $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opADC
	fetch_c 4
;----------------------------------------------------------------------------
_7E;   ROR $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opROR
	fetch 7
;----------------------------------------------------------------------------
_81;   STA ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opSTORE m6502_a
	fetch 6
;----------------------------------------------------------------------------
_84;   STY $nn
;----------------------------------------------------------------------------
	doZ
	opSTORE m6502_y
	fetch 3
;----------------------------------------------------------------------------
_85;   STA $nn
;----------------------------------------------------------------------------
	doZ
	opSTORE m6502_a
	fetch 3
;----------------------------------------------------------------------------
_86;   STX $nn
;----------------------------------------------------------------------------
	doZ
	opSTORE m6502_x
	fetch 3
;----------------------------------------------------------------------------
_88;   DEY
;----------------------------------------------------------------------------
	sub m6502_y,m6502_y,#0x01000000
	mov m6502_nz,m6502_y,asr#24
	fetch 2
;----------------------------------------------------------------------------
_8A;   TXA
;----------------------------------------------------------------------------
	mov m6502_a,m6502_x
	mov m6502_nz,m6502_x,asr#24
	fetch 2
;----------------------------------------------------------------------------
_8C;   STY $nnnn
;----------------------------------------------------------------------------
	doABS
	opSTORE m6502_y
	fetch 4
;----------------------------------------------------------------------------
_8D;   STA $nnnn
;----------------------------------------------------------------------------
	doABS
	opSTORE m6502_a	  ;**************************************************************
	fetch 4
;----------------------------------------------------------------------------
_8E;   STX $nnnn
;----------------------------------------------------------------------------
	doABS
	opSTORE m6502_x
	fetch 4
;----------------------------------------------------------------------------
_90;   BCC *
;----------------------------------------------------------------------------
	tst cycles,#CYC_C			;Test Carry
	ldrsb r0,[m6502_pc],#1
	addeq m6502_pc,m6502_pc,r0
;	subeq cycles,cycles,#3*CYCLE
	subeq cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_91;   STA ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opSTORE m6502_a
	fetch 6
;----------------------------------------------------------------------------
_94;   STY $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opSTORE m6502_y
	fetch 4
;----------------------------------------------------------------------------
_95;   STA $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opSTORE m6502_a
	fetch 4
;----------------------------------------------------------------------------
_96;   STX $nn,Y
;----------------------------------------------------------------------------
	doZIYf
	opSTORE m6502_x
	fetch 4
;----------------------------------------------------------------------------
_98;   TYA
;----------------------------------------------------------------------------
	mov m6502_a,m6502_y
	mov m6502_nz,m6502_y,asr#24
	fetch 2
;----------------------------------------------------------------------------
_99;   STA $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opSTORE m6502_a
	fetch 5
;----------------------------------------------------------------------------
_9A;   TXS
;----------------------------------------------------------------------------
	mov r0,m6502_x,lsr#24
	strb r0,m6502_s
	fetch 2
;----------------------------------------------------------------------------
_9D;   STA $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opSTORE m6502_a
	fetch 5
;----------------------------------------------------------------------------
_A0;   LDY #$nn
;----------------------------------------------------------------------------
	doIMM
	opLOAD m6502_y
	fetch 2
;----------------------------------------------------------------------------
_A1;   LDA ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opLOAD m6502_a
	fetch 6
;----------------------------------------------------------------------------
_A2;   LDX #$nn
;----------------------------------------------------------------------------
	doIMM
	opLOAD m6502_x
	fetch 2
;----------------------------------------------------------------------------
_A4;   LDY $nn
;----------------------------------------------------------------------------
	doZ
	opLOAD m6502_y
	fetch 3
;----------------------------------------------------------------------------
_A5;   LDA $nn
;----------------------------------------------------------------------------
	doZ
	opLOAD m6502_a
	fetch 3
;----------------------------------------------------------------------------
_A6;   LDX $nn
;----------------------------------------------------------------------------
	doZ
	opLOAD m6502_x
	fetch 3
;----------------------------------------------------------------------------
_A8;   TAY
;----------------------------------------------------------------------------
	mov m6502_y,m6502_a
	mov m6502_nz,m6502_y,asr#24
	fetch 2
;----------------------------------------------------------------------------
_A9;   LDA #$nn
;----------------------------------------------------------------------------
	doIMM
	opLOAD m6502_a
	fetch 2
;----------------------------------------------------------------------------
_AA;   TAX
;----------------------------------------------------------------------------
	mov m6502_x,m6502_a
	mov m6502_nz,m6502_x,asr#24
	fetch 2
;----------------------------------------------------------------------------
_AC;   LDY $nnnn
;----------------------------------------------------------------------------
	doABS
	opLOAD m6502_y
	fetch 4
;----------------------------------------------------------------------------
_AD;   LDA $nnnn
;----------------------------------------------------------------------------
	doABS
	opLOAD m6502_a
	fetch 4
;----------------------------------------------------------------------------
_AE;   LDX $nnnn
;----------------------------------------------------------------------------
	doABS
	opLOAD m6502_x
	fetch 4
;----------------------------------------------------------------------------
_B0;   BCS *
;----------------------------------------------------------------------------
	tst cycles,#CYC_C			;Test Carry
	ldrsb r0,[m6502_pc],#1
	addne m6502_pc,m6502_pc,r0
;	subne cycles,cycles,#3*CYCLE
	subne cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_B1;   LDA ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opLOAD m6502_a
	fetch 5
;----------------------------------------------------------------------------
_B4;   LDY $nn,X
;----------------------------------------------------------------------------
	doZIX
	opLOAD m6502_y
	fetch 4
;----------------------------------------------------------------------------
_B5;   LDA $nn,X
;----------------------------------------------------------------------------
	doZIX
	opLOAD m6502_a
	fetch 4
;----------------------------------------------------------------------------
_B6;   LDX $nn,Y
;----------------------------------------------------------------------------
	doZIY
	opLOAD m6502_x
	fetch 4
;----------------------------------------------------------------------------
_B8;   CLV
;----------------------------------------------------------------------------
	bic cycles,cycles,#CYC_V
	fetch 2
;----------------------------------------------------------------------------
_B9;   LDA $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opLOAD m6502_a
	fetch 4
;----------------------------------------------------------------------------
_BA;   TSX
;----------------------------------------------------------------------------
	ldrb m6502_x,m6502_s
	mov m6502_x,m6502_x,lsl#24
	mov m6502_nz,m6502_x,asr#24
	fetch 2
;----------------------------------------------------------------------------
_BC;   LDY $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opLOAD m6502_y
	fetch 4
;----------------------------------------------------------------------------
_BD;   LDA $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opLOAD m6502_a
	fetch 4
;----------------------------------------------------------------------------
_BE;   LDX $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opLOAD m6502_x
	fetch 4
;----------------------------------------------------------------------------
_C0;   CPY #$nn
;----------------------------------------------------------------------------
	doIMM
	opCOMP m6502_y
	fetch_c 2
;----------------------------------------------------------------------------
_C1;   CMP ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opCOMP m6502_a
	fetch_c 6
;----------------------------------------------------------------------------
_C4;   CPY $nn
;----------------------------------------------------------------------------
	doZ
	opCOMP m6502_y
	fetch_c 3
;----------------------------------------------------------------------------
_C5;   CMP $nn
;----------------------------------------------------------------------------
	doZ
	opCOMP m6502_a
	fetch_c 3
;----------------------------------------------------------------------------
_C6;   DEC $nn
;----------------------------------------------------------------------------
	doZ
	opDEC
	fetch 5
;----------------------------------------------------------------------------
_C8;   INY
;----------------------------------------------------------------------------
	add m6502_y,m6502_y,#0x01000000
	mov m6502_nz,m6502_y,asr#24
	fetch 2
;----------------------------------------------------------------------------
_C9;   CMP #$nn
;----------------------------------------------------------------------------
	doIMM
	opCOMP m6502_a
	fetch_c 2
;----------------------------------------------------------------------------
_CA;   DEX
;----------------------------------------------------------------------------
	sub m6502_x,m6502_x,#0x01000000
	mov m6502_nz,m6502_x,asr#24
	fetch 2
;----------------------------------------------------------------------------
_CC;   CPY $nnnn
;----------------------------------------------------------------------------
	doABS
	opCOMP m6502_y
	fetch_c 4
;----------------------------------------------------------------------------
_CD;   CMP $nnnn
;----------------------------------------------------------------------------
	doABS
	opCOMP m6502_a
	fetch_c 4
;----------------------------------------------------------------------------
_CE;   DEC $nnnn
;----------------------------------------------------------------------------
	doABS
	opDEC
	fetch 6
;----------------------------------------------------------------------------
_D0;   BNE *
;----------------------------------------------------------------------------
	tst m6502_nz,#0xff
	ldrsb r0,[m6502_pc],#1
	addne m6502_pc,m6502_pc,r0
;	subne cycles,cycles,#3*CYCLE
	subne cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_D1;   CMP ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opCOMP m6502_a
	fetch_c 5
;----------------------------------------------------------------------------
_D5;   CMP $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opCOMP m6502_a
	fetch_c 4
;----------------------------------------------------------------------------
_D6;   DEC $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opDEC
	fetch 6
;----------------------------------------------------------------------------
_D8;   CLD
;----------------------------------------------------------------------------
	bic cycles,cycles,#CYC_D
	fetch 2
;----------------------------------------------------------------------------
_D9;   CMP $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opCOMP m6502_a
	fetch_c 4
;----------------------------------------------------------------------------
_DD;   CMP $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opCOMP m6502_a
	fetch_c 4
;----------------------------------------------------------------------------
_DE;   DEC $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opDEC
	fetch 7
;----------------------------------------------------------------------------
_E0;   CPX #$nn
;----------------------------------------------------------------------------
	doIMM
	opCOMP m6502_x
	fetch_c 2
;----------------------------------------------------------------------------
_E1;   SBC ($nn,X)
;----------------------------------------------------------------------------
	doIIX
	opSBC
	fetch_c 6
;----------------------------------------------------------------------------
_E4;   CPX $nn
;----------------------------------------------------------------------------
	doZ
	opCOMP m6502_x
	fetch_c 3
;----------------------------------------------------------------------------
_E5;   SBC $nn
;----------------------------------------------------------------------------
	doZ
	opSBC
	fetch_c 3
;----------------------------------------------------------------------------
_E6;   INC $nn
;----------------------------------------------------------------------------
	doZ
	opINC
	fetch 5
;----------------------------------------------------------------------------
_E8;   INX
;----------------------------------------------------------------------------
	add m6502_x,m6502_x,#0x01000000
	mov m6502_nz,m6502_x,asr#24
	fetch 2
;----------------------------------------------------------------------------
_E9;   SBC #$nn
;----------------------------------------------------------------------------
	doIMM
	opSBC
	fetch_c 2
;----------------------------------------------------------------------------
_EA;   NOP
;----------------------------------------------------------------------------
	fetch 2
;----------------------------------------------------------------------------
_EC;   CPX $nnnn
;----------------------------------------------------------------------------
	doABS
	opCOMP m6502_x
	fetch_c 4
;----------------------------------------------------------------------------
_ED;   SBC $nnnn
;----------------------------------------------------------------------------
	doABS
	opSBC
	fetch_c 4
;----------------------------------------------------------------------------
_EE;   INC $nnnn
;----------------------------------------------------------------------------
	doABS
	opINC
	fetch 6
;----------------------------------------------------------------------------
_F0;   BEQ *
;----------------------------------------------------------------------------
	tst m6502_nz,#0xff
	ldrsb r0,[m6502_pc],#1
	addeq m6502_pc,m6502_pc,r0
;	subeq cycles,cycles,#3*CYCLE
	subeq cycles,cycles,#256
	fetch 2
;----------------------------------------------------------------------------
_F1;   SBC ($nn),Y
;----------------------------------------------------------------------------
	doIIY
	opSBC
	fetch_c 5
;----------------------------------------------------------------------------
_F5;   SBC $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opSBC
	fetch_c 4
;----------------------------------------------------------------------------
_F6;   INC $nn,X
;----------------------------------------------------------------------------
	doZIXf
	opINC
	fetch 6
;----------------------------------------------------------------------------
_F8;   SED
;----------------------------------------------------------------------------
	orr cycles,cycles,#CYC_D
	fetch 2
;----------------------------------------------------------------------------
_F9;   SBC $nnnn,Y
;----------------------------------------------------------------------------
	doAIY
	opSBC
	fetch_c 4
;----------------------------------------------------------------------------
_FD;   SBC $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opSBC
	fetch_c 4
;----------------------------------------------------------------------------
_FE;   INC $nnnn,X
;----------------------------------------------------------------------------
	doAIX
	opINC
	fetch 7
;----------------------------------------------------------------------------

	AREA cpu_run, CODE, READONLY
run	PROC;r0=要运行的cpu周期*256
;----------------------------------------------------------------------------
	
	stmfd sp!,{r4-r11,lr}		;将这几个寄存器中的值保存到堆栈中

	ldr globalptr,=op_table	 ;r10   wram_globals:代码跳转表  读取代码跳转表地址
	ldr cpu_zpage,=NES_RAM			   	;r11

;******************************	测试用的	
;	ldr r0,=prg_rombank0
;	ldr r0,[r0]
;	ldr r1,=prg_rombank1
;	ldr r1,[r1]
;	ldr r2,memmap_tbl+16
;	ldr r3,memmap_tbl+20
;	ldr r4,memmap_tbl+24
;	ldr r5,memmap_tbl+28
;***********************************

	adr r1,cpuregs
	ldmia r1,{m6502_nz-m6502_pc}	;restore 6502 state恢复6502状态	 r3-r9
	add cycles,cycles,r0
	fetch 0					   ;//提取操作码并运行

exit_run  
	adr r0,cpuregs
	stmia r0,{m6502_nz-m6502_pc} ;保存6502状态	  r3-r9

	ldmfd sp!,{r4-r11,pc}	;exit 
;	bx lr						
	ENDP

;***************************************************************************************
line242NMI PROC;---------------------------
	stmfd sp!,{r4-r11,lr}
	ldr globalptr,=op_table
	ldr cpu_zpage,=NES_RAM			   	;r11

	adr r0,cpuregs
	ldmia r0,{m6502_nz-m6502_pc}	;restore 6502 state恢复6502状态

	ldr r12,=NMI_VECTOR		 ;NMI?	 addy
	bl Vec6502
	sub cycles,cycles,#7*256	;CYCLE=256	 6502的中断潜伏期为七 (7) 个周
                              ; 期; 这也就是说需要需要七 (7) 个周期来移入和移出一个中断.

	adr r0,cpuregs
	stmia r0,{m6502_nz-m6502_pc}	;保存6502状态

	ldmfd sp!,{r4-r11,pc}	;
;	bx lr						;return 
	ENDP
;----------------------------------------------------------------------------

default_scanlinehook
	fetch 0
;----------------------------------------------------------
CheckI								;Check Interrupt Disable 检查中断禁用
;----------------------------------------------------------
	tst cycles,#CYC_I
	bne default_scanlinehook		;we dont want no stinkin irqs 我们不希望没有发臭的IRQ
;----------------------------------------------------------
irq6502
;----------------------------------------------------------
	ldr r12,=IRQ_VECTOR
	bl Vec6502
	fetch 7
;----------------------------------------------------------
Vec6502
;----------------------------------------------------------
	ldr r0,lastbank
	sub r0,m6502_pc,r0
	push16					;save PC

	encodeP (R)				;save P
VecCont
	push8 r0

	orr cycles,cycles,#CYC_I	;disable IRQ	禁用IRQ

	ldr r0,memmap_tbl+7*4	  ;7*4
;	ldrb m6502_pc,[r0,r12]!
	ldrb m6502_pc,[r0,r12]	;在数据传送之前,将偏移量加到Rn 中,其结果作为传送数据的存储地址
                            ;若使用后缀"!",则结果写回到Rn中
	add r0,r0,r12			 ;R12=0xfffc ;// 复位中断向量地址
	
	ldrb r2,[r0,#1]
	orr m6502_pc,m6502_pc,r2,lsl#8
	encodePC				;get IRQ vector得到6502 PC ROM的偏移量

	bx lr					  ; 函数返回
	nop
;----------------------------------------------------------------------------
_xx;	???					;invalid opcode	无效的操作码
;----------------------------------------------------------------------------
;	[ DEBUG
;		adr r0,_xx
;		mov r1,#0
;		b _xx
;	]
	fetch 2
;----------------------------------------------------------------------------

;----------------------------------------------------------------------------
CPU_reset PROC	;called by loadcart (r0-r9 are free to use)
;----------------------------------------------------------------------------
	str lr,[sp,#-4]!
	mov m6502_a,#0
	mov m6502_x,#0
	mov m6502_y,#0
	mov m6502_nz,#0
	adr m6502_rmem,readmem_tbl ;把readmem_tbl的地址加载到m6502_rmem
	ldr r0,=NES_RAM+0x100	   ;256
	str r0,m6502_s		;S=0xFD (0x100-3)	  把一个寄存器按字存储到存储器中
	mov cycles,#0		;D=0, C=0, V=0, I=1 disable IRQ.

	ldr r12,=RES_VECTOR		 ;// 复位中断向量地址
	bl Vec6502

	adr r0,cpuregs			 ;读取地址
	stmia r0,{m6502_nz-m6502_pc}	   ;保存6502状态

	ldr r1,=exit_run				  ;
	str r1,nexttimeout		  ;保存指令执行完后下一步的PC地址

	ldr pc,[sp],#4
	ENDP
;	nop
;-------------------------------------------------------------------------

   AREA rwram_code, CODE, READONLY;READWRITE**************************************
;----------------------------------------------------------------------------
;memory
;------------------------------------------------------------------------
empty_R		;读地址不正确read bad address (error)
;----------------------------------------------------------------------------
;	[ DEBUG
;		mov r0,r12
;		mov r1,#0
		b empty_R
;	]
void ;- - - - - - - - -空函数
;	mov r0,#0	;VS excitebike likes this
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr


;----------------------------------------------------------------------------
ram_R	;ram read ($0000-$1FFF)
;----------------------------------------------------------------------------
	bic addy,addy,#0x1f800		;only 0x07FF is RAM
	ldrb r0,[cpu_zpage,addy]
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
ram_W	;ram write ($0000-$1FFF)
;----------------------------------------------------------------------------
	bic addy,addy,#0x1f800		;only 0x07FF is RAM
	strb r0,[cpu_zpage,addy]   ; cpu_zpage	RN r11 ;=CPU_RAM
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------

;----------------------------------------------------------------------------
rom_R60	;rom read ($6000-$7FFF)
;----------------------------------------------------------------------------
	ldr r1,memmap_tbl+12
	ldrb r0,[r1,addy]
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
rom_R80	;rom read ($8000-$9FFF)
;----------------------------------------------------------------------------
	ldr r1,memmap_tbl+16
	ldrb r0,[r1,addy]
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
rom_RA0	;rom read ($A000-$BFFF)
;----------------------------------------------------------------------------
	ldr r1,memmap_tbl+20
	ldrb r0,[r1,addy]
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
rom_RC0	;rom read ($C000-$DFFF)
;----------------------------------------------------------------------------
	ldr r1,memmap_tbl+24
	ldrb r0,[r1,addy]
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
rom_RE0	;rom read ($E000-$FFFF)
;----------------------------------------------------------------------------
	ldr r1,memmap_tbl+28
	ldrb r0,[r1,addy]
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
;filler_ ;r0=0data r1=NES_RAMdest目的 r2=2560word count字数统计	   填料
;	exit with r0 unchanged	   退出R0不变
;----------------------------------------------------------------------------
;	subs r2,r2,#1		  ;-1
;	ldr r0,[r3,r2,lsl#2]
;	str r0,[r1,r2,lsl#2]  ;<<2
;	bne filler_
;	orr lr,#0x01		;lr最低位置1防止进入arm状态
;	bx lr
	nop
;----------------------------------------------------------------------------
;IO
   AREA io_code, CODE, READONLY ;--
;----------------------------------------------------------------------------

;----------------------------------------------------------------------------
IO_R		;I/O read
;----------------------------------------------------------------------------
	sub r2,r12,#0x4000	 ;addy=r12
	subs r2,r2,#0x15

;	orr lr,#0x01		;lr最低位置1防止进入arm状态
;	bx lr			  ;暂时不读，直接返回

	bmi empty_R		  ;读地址不正确
	cmp r2,#3
;	ldrmi pc,[pc,r2,lsl#2]
	ldr r1,=io_read_tbl   ;//改过，加3行
	add r1,r1,r2,lsl#2			  ;<<2
	ldrmi pc,[r1]			;//直接操作pc太他妈危险了
	b empty_R		            ;读地址不正确
;	nop

io_read_tbl
	DCD void;_4015r	;4015 (sound)
	DCD joy0_R	;4016: controller 1
	DCD void;joy1_R	;4017: controller 2
;----------------------------------------------------------------------------
IO_W		;I/O write
;----------------------------------------------------------------------------
	sub r2,r12,#0x4000	   ;addy=r12
	cmp r2,#0x18
	
;	ldrmi pc,[pc,r2,lsl#2]
	ldr r1,=io_write_tbl   ;//改过，加3行
	add r1,r1,r2,lsl#2			  ;<<2
;	ldrmi pc,[r1]			;//直接操作pc太他妈危险了
	ldr pc,[r1]
;	b empty_R
 ;   nop
io_write_tbl	
	DCD void;_4000w
	DCD void;_4001w
	DCD void;_4002w
	DCD void;_4003w
	DCD void;_4004w
	DCD void;_4005w
	DCD void;_4006w
	DCD void;_4007w
	DCD void;_4008w
	DCD void;
	DCD void;_400aw
	DCD void;_400bw
	DCD void;_400cw
	DCD void
	DCD void;_400ew
	DCD void;_400fw
	DCD void;_4010w
	DCD void;_4011w
	DCD void;_4012w
	DCD void;_4013w
	DCD dma_W	;$4014: Sprite DMA transfer
	DCD void;_4015w		 ; 声音通道切换 
joypad_write_ptr
	DCD joy0_W	;$4016: Joypad 0 write
	DCD void	;$4017: ?

;----------------------------------------------------------------------------
dma_W	;(4014)		sprite DMA transfer	精灵DMA传输	DMA访问精灵RAM：
;通过写一个值xx到这个端口，引起CPU内存地址为$xx00－$xxFF的区域传送到精灵内存 
;----------------------------------------------------------------------------

	sub cycles,cycles,#512*256
	stmfd sp!,{r3,lr}

	and r1,r0,#0xe0
	adr r2,memmap_tbl
	lsr r1,r1,#3
	ldr r2,[r2,r1]
	and r0,r0,#0xff
	add r2,r2,r0,lsl#8	;addy  r2=DMA source 源
	ldr r1,=spr_ram		;r1     DMA的 目的地
	mov r0,#64
copy_
	subs r0,r0,#1		  ;-1
	ldr r3,[r2,r0,lsl#2]
	str r3,[r1,r0,lsl#2]  ;<<2	   *4
	bne copy_

	ldmfd sp!,{r3,lr}
	orr lr,#0x01		;lr最低位置1防止进入arm状态
    bx lr
;----------------------------------------------------------------------------
;---------------------------------------------

joy0_W		;4016  手柄1＋选通 
;----------------------------------------------------------------------------
	tst r0,#1
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bxne lr

	ldr r0,=0x40011408 ; 端口输入数据寄存器(GPIOD_IDR)0x40011408	按键端口
	ldr r0,[r0]		  ;	 PD9    11     12    13    14    15设置成的输入	   按下为0
				   ;   key 6     1      2	  3	    4	  5

			;	((右  <<7)|(左  <<6)|(下  <<5)|(上  <<4)|Start<<3)|Select<<2)|(B  <<1)| A   )
			;	  		5		  3								1		   2			4	按键编号
	
	lsr r0,r0,#8	  ;>>8  只要高8位
	rsb r0,r0,#0xff   ; R0 = #0xff-R0      反向减法?   取反		  按下为1
					;			 76543210
					;			 54321 6		 按键编号
					;			 11111010		 8位数据

	and r2,r0,#0x80   ;按键5 在对应位

	and r1,r0,#0x20   ;按键3
	orr r2,r1,lsl#1	  ;			<<1

	and r1,r0,#0x8 ;按键1
	orr r2,r1		 ;按键1 在对应位

	and r1,r0,#0x10 ;按键2
	orr r2,r1,lsr#2 ;        >>2

	and r1,r0,#0x40 ;按键4
	orr r2,r1,lsr#6  ;    >>6		  r2是键值
	orr r2,r2,#0x100000		   ;20位表示控制器在位

	str r2,joy0serial
;	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
joy0_R		;4016
;----------------------------------------------------------------------------	

	ldr r0,joy0serial	   ;串行数据  当前读取位
	mov r1,r0,lsr#1
	str r1,joy0serial
	and r0,r0,#1	
	orr r0,r0,#0x40

    orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;----------------------------------------------------------------------------
joy1_R		;4017
;----------------------------------------------------------------------------
	mov r0,#0x00			  ;手柄1存在
	orr r0,r0,#0xf8
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
	nop
;----------------------------
;ppu_io
	 AREA CPU_GPU, CODE, READONLY

	IMPORT PPU_RegWrite		  ;PPU.c
	IMPORT PPU_RegRead		  ;PPU.c
;------------------------------------------------------------------------------------
PPU_W
	stmfd sp!,{lr}	;LR 寄存器放栈      
	and r1,r12,#7		 ;addy	RN r12
				    ; 汇编要呼叫C函数，则考虑问题的方式就有所不同 
                    ;必须意识到子程序可以随心所欲地改写R0\R3,?R12，却决不 
                    ;会改变R4\R11
	
	bl PPU_RegWrite
	ldmfd sp!,{lr}
	orr lr,#0x01		;lr最低位置1防止进入arm状态
	bx lr
;--------------------------------------------------------------------------------------
PPU_R
	stmfd sp!,{r4,lr}	;LR 寄存器放栈    会改变R4  
	and r0,r12,#7		 ;addy	RN r12
	bl PPU_RegRead
	ldmfd sp!,{r4,lr}
    orr lr,#0x01
	bx lr
;----------------------------------------------------------------------------------------

;----------------------------------------------------------
	AREA wram_globals0, DATA, READWRITE;*
op_table	   ;DCD 用于分配一段字内存单元 op_table内存块起始地址标号
	DCD _00,_01,_xx,_xx,_xx,_05,_06,_xx,_08,_09,_0A,_xx,_xx,_0D,_0E,_xx
	DCD _10,_11,_xx,_xx,_xx,_15,_16,_xx,_18,_19,_xx,_xx,_xx,_1D,_1E,_xx
	DCD _20,_21,_xx,_xx,_24,_25,_26,_xx,_28,_29,_2A,_xx,_2C,_2D,_2E,_xx
	DCD _30,_31,_xx,_xx,_xx,_35,_36,_xx,_38,_39,_xx,_xx,_xx,_3D,_3E,_xx
	DCD _40,_41,_xx,_xx,_xx,_45,_46,_xx,_48,_49,_4A,_xx,_4C,_4D,_4E,_xx
	DCD _50,_51,_xx,_xx,_xx,_55,_56,_xx,_58,_59,_xx,_xx,_xx,_5D,_5E,_xx
	DCD _60,_61,_xx,_xx,_xx,_65,_66,_xx,_68,_69,_6A,_xx,_6C,_6D,_6E,_xx
	DCD _70,_71,_xx,_xx,_xx,_75,_76,_xx,_78,_79,_xx,_xx,_xx,_7D,_7E,_xx
	DCD _xx,_81,_xx,_xx,_84,_85,_86,_xx,_88,_xx,_8A,_xx,_8C,_8D,_8E,_xx
	DCD _90,_91,_xx,_xx,_94,_95,_96,_xx,_98,_99,_9A,_xx,_xx,_9D,_xx,_xx
	DCD _A0,_A1,_A2,_xx,_A4,_A5,_A6,_xx,_A8,_A9,_AA,_xx,_AC,_AD,_AE,_xx
	DCD _B0,_B1,_xx,_xx,_B4,_B5,_B6,_xx,_B8,_B9,_BA,_xx,_BC,_BD,_BE,_xx
	DCD _C0,_C1,_xx,_xx,_C4,_C5,_C6,_xx,_C8,_C9,_CA,_xx,_CC,_CD,_CE,_xx
	DCD _D0,_D1,_xx,_xx,_xx,_D5,_D6,_xx,_D8,_D9,_xx,_xx,_xx,_DD,_DE,_xx
	DCD _E0,_E1,_xx,_xx,_E4,_E5,_E6,_xx,_E8,_E9,_EA,_xx,_EC,_ED,_EE,_xx
	DCD _F0,_F1,_xx,_xx,_xx,_F5,_F6,_xx,_F8,_F9,_xx,_xx,_xx,_FD,_FE,_xx
  ;readmem_tbl													254 255
	DCD ram_R	;$0000				256
	DCD PPU_R	;$2000
	DCD IO_R	;$4000
	DCD void    ;sram_R	;$6000
	DCD rom_R80	;$8000
	DCD rom_RA0	;$A000
	DCD rom_RC0	;$C000
	DCD rom_RE0	;$E000
  ;writemem_tbl
	DCD ram_W	;$0000			  264*4=1056  0X420
	DCD PPU_W	;$2000	  r0传参数
	DCD IO_W	;$4000
	DCD void    ;sram_W	;$6000
	DCD void	;$8000
	DCD void	;$A000
	DCD void	;$C000
	DCD void	;$E000
   ;memmap_tbl		存储器映象
	DCD NES_RAM		;$0000   0000-7fff	 keep $400 byte aligned for 6502 stack shit
	DCD NES_RAM		;$2000    should	  保持400字节6502狗屎堆对齐
	DCD NES_RAM		;$4000     never
	DCD NES_RAM;-0x5800;void;   NES_RAM-0x5800	;$6000      change改变
rommap	% 4*4			;$8000-FFFF	 memmap_tbl+16

cpustate
	;group these together for save/loadstate
	% 7*4 ;cpuregs (nz,c,a,x,y,cycles,pc)
	DCD 0 ;m6502_s:
	DCD 0 ;lastbank: 最后MEMMAP添加到PC （用于计算当前的PC ）

	DCD 0 ;nexttimeout:  jump here when cycles runs out	跳到下一个时钟周期运行

    DCD 0   ;rombase # 4			;//ROM开始地址
    DCD 0   ;romnumber # 4		 ;// 
    DCD 0   ;rommask # 4		   ;//ROM掩膜	rommask=romsize-1

	DCD 0   ;joy0serial # 4	   ;//串行数据


;----------------------------------------------------------------------------
;	ALIGN           ;通过用零或空指令NOP填充，来使当前位置与一个指定的边界对齐
	END

